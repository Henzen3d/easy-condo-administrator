import{c as Ne,r as n,z as ve,J as t,s as ee,j as e,a as c,K as be,L as Ce,M as we,D as De,b as Pe,d as Ie,e as y,N as ke,B as Se,Y as Ee,C as Fe,Z as Ae,I as H}from"./index-PF3D36V0.js";import{D as F,a as A,b as T,c as R,d as O,i as V,S as Q,e as _,f as J,g as U,h as u}from"./select-BUw1FKH9.js";import{T as ae,a as se,b as x,c as l,d as re,e as i,P as Te}from"./table-Pv-7lEPL.js";import{T as Re,a as Oe,b as M,L as p}from"./tabs-DTHgOjkY.js";import{a as Ve,P as Me,b as N,m as Be,e as ze}from"./invoiceService-_JBDSHYM.js";import{E as Le,g as Xe}from"./pdfService-Bwb66BPv.js";import{h as He,g as Qe}from"./pixService-DVuueQii.js";import{F as _e}from"./filter-C6oRDaef.js";import{E as Je}from"./eye-CcKAEFEB.js";import{D as Ue}from"./download-Cr82A7Gw.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=Ne("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]),te=({status:j})=>{const v={pending:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300",paid:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300",overdue:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"},b={pending:"Pendente",paid:"Pago",overdue:"Atrasado"};return e.jsx("span",{className:`px-2.5 py-0.5 rounded-full text-xs font-medium ${v[j]}`,children:b[j]})},ta=()=>{const[j,v]=n.useState([]),[b,B]=n.useState([]),[ne,Y]=n.useState(!0),[C,oe]=n.useState("all"),[r,w]=n.useState(null),[ie,D]=n.useState(!1),[ce,P]=n.useState(!1),[de,I]=n.useState(!1),[le,z]=n.useState(!1),[k,me]=n.useState(null),[q,ue]=n.useState(!1),{bankAccounts:G,addTransaction:W,updateBankAccount:he}=ve(),[o,S]=n.useState({method:"pix",accountId:"",date:new Date().toISOString().split("T")[0]}),[m,E]=n.useState({dueDate:"",notes:"",status:""}),g=n.useCallback(async()=>{Y(!0);try{const a=await Ve();v(a),B(a)}catch(a){console.error("Erro ao buscar faturas:",a),t.error("Erro ao carregar faturas")}finally{Y(!1)}},[]),$=n.useCallback(async()=>{try{const{data:a,error:s}=await ee.from("bank_accounts").select("*").order("name");if(s)throw s;setBankAccounts(a||[]),a&&a.length>0&&S(d=>({...d,accountId:a[0].id.toString()}))}catch(a){console.error("Erro ao buscar contas bancárias:",a)}},[]);n.useEffect(()=>{async function a(){const s=await He();ue(s)}a()},[]),n.useEffect(()=>{g(),$(),(async()=>{try{const{error:s}=await ee.rpc("update_overdue_invoices");if(s)throw s}catch(s){console.error("Erro ao verificar faturas vencidas:",s)}})()},[g,$]),n.useEffect(()=>{B(C==="all"?j:j.filter(a=>a.status===C))},[C,j]);const xe=async a=>{try{const s=await N(a);s?(w(s),D(!0)):t.error("Fatura não encontrada")}catch(s){console.error("Erro ao visualizar fatura:",s),t.error("Erro ao carregar detalhes da fatura")}},K=async a=>{try{const s=await N(a);s?(w(s),P(!0)):t.error("Fatura não encontrada")}catch(s){console.error("Erro ao abrir diálogo de pagamento:",s),t.error("Erro ao carregar detalhes da fatura")}},je=async a=>{try{const s=await N(a);s?(w(s),E({dueDate:s.dueDate,notes:s.notes||"",status:s.status}),I(!0)):t.error("Fatura não encontrada")}catch(s){console.error("Erro ao abrir diálogo de edição:",s),t.error("Erro ao carregar detalhes da fatura")}},pe=async()=>{if(r)try{if(!o.accountId){t.error("Selecione uma conta bancária");return}const a=parseInt(o.accountId),s=await Be(r.id,o.method,a,o.date);if(s.success){v(f=>f.map(h=>h.id===r.id?{...h,status:"paid",paymentDate:o.date,paymentMethod:o.method,paymentAccountId:a}:h));const d=G.find(f=>f.id===a);d&&(s.transaction?W({id:s.transaction.id,account:a.toString(),amount:s.transaction.amount,category:s.transaction.category,date:s.transaction.date,description:s.transaction.description,payee:s.transaction.payee,status:s.transaction.status,type:s.transaction.type,unit:s.transaction.unit}):W({id:Date.now(),account:a.toString(),amount:r.totalAmount,category:"Receita",date:o.date,description:`Pagamento da fatura ${r.invoiceNumber}`,payee:r.resident,status:"completed",type:"income",unit:r.unit}),he({...d,balance:s.newBalance||d.balance+r.totalAmount})),t.success("Pagamento registrado com sucesso"),P(!1),g()}else t.error("Erro ao registrar pagamento")}catch(a){console.error("Erro ao processar pagamento:",a),t.error("Erro ao registrar pagamento")}},ge=async()=>{if(r)try{await ze(r.id,{dueDate:m.dueDate,notes:m.notes,status:m.status})?(t.success("Fatura atualizada com sucesso"),I(!1),g()):t.error("Erro ao atualizar fatura")}catch(a){console.error("Erro ao salvar edições:",a),t.error("Erro ao atualizar fatura")}},fe=async a=>{try{const s=await N(a.id);if(!s){t.error("Fatura não encontrada");return}const d=s.items.map(h=>({id:h.billingId,unit:s.unit,resident:s.resident,description:h.description,amount:h.amount,dueDate:s.dueDate,status:"pending",isPrinted:!0,isSent:!1})),f=Xe(s.unit,s.resident,d,s.totalAmount);window.open(f,"_blank"),t.success("Fatura reimpressa com sucesso")}catch(s){console.error("Erro ao reimprimir fatura:",s),t.error("Erro ao reimprimir fatura")}},ye=async a=>{try{if(!q){t.error("Nenhuma conta bancária com chave PIX configurada");return}const s=await N(a);if(s){w(s);const d=await Qe(a);d?(me(d),z(!0)):t.error("Erro ao gerar QR Code PIX")}else t.error("Fatura não encontrada")}catch(s){console.error("Erro ao gerar PIX:",s),t.error("Erro ao gerar PIX")}},L=a=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(a),X=a=>{const s=new Date(a);return new Intl.DateTimeFormat("pt-BR").format(s)},Z=a=>["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][a];return e.jsxs("div",{className:"container max-w-7xl mx-auto py-6 space-y-6 animate-fade-in",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight animate-slide-in-top",children:"Histórico de Faturas"}),e.jsx("p",{className:"text-muted-foreground animate-slide-in-top animation-delay-200",children:"Visualize e gerencie as faturas geradas para as unidades do condomínio."})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs(c,{variant:"outline",className:"gap-2",onClick:()=>g(),children:[e.jsx(Ye,{size:16}),e.jsx("span",{children:"Atualizar"})]}),e.jsxs(c,{variant:"outline",className:"gap-2",children:[e.jsx(_e,{size:16}),e.jsx("span",{children:"Filtrar"})]})]}),e.jsxs(be,{children:[e.jsx(Ce,{className:"pb-0",children:e.jsx(Re,{value:C,onValueChange:oe,children:e.jsxs(Oe,{children:[e.jsx(M,{value:"all",children:"Todas"}),e.jsx(M,{value:"pending",children:"Pendentes"}),e.jsx(M,{value:"paid",children:"Pagas"}),e.jsx(M,{value:"overdue",children:"Atrasadas"})]})})}),e.jsx(we,{children:e.jsx("div",{className:"rounded-md border mt-4",children:e.jsxs(ae,{children:[e.jsx(se,{children:e.jsxs(x,{children:[e.jsx(l,{children:"Número"}),e.jsx(l,{children:"Unidade"}),e.jsx(l,{children:"Morador"}),e.jsx(l,{children:"Referência"}),e.jsx(l,{children:"Vencimento"}),e.jsx(l,{children:"Valor"}),e.jsx(l,{children:"Status"}),e.jsx(l,{className:"text-right",children:"Ações"})]})}),e.jsx(re,{children:ne?e.jsx(x,{children:e.jsx(i,{colSpan:8,className:"text-center py-6 text-muted-foreground",children:"Carregando faturas..."})}):b.length===0?e.jsx(x,{children:e.jsx(i,{colSpan:8,className:"text-center py-6 text-muted-foreground",children:"Nenhuma fatura encontrada."})}):b.map(a=>e.jsxs(x,{children:[e.jsx(i,{children:a.invoiceNumber}),e.jsx(i,{children:a.unit}),e.jsx(i,{children:a.resident}),e.jsxs(i,{children:[Z(a.referenceMonth),"/",a.referenceYear]}),e.jsx(i,{children:X(a.dueDate)}),e.jsx(i,{children:L(a.totalAmount)}),e.jsx(i,{children:e.jsx(te,{status:a.status})}),e.jsx(i,{className:"text-right",children:e.jsxs(De,{children:[e.jsx(Pe,{asChild:!0,children:e.jsx(c,{variant:"ghost",size:"icon",children:e.jsx(Le,{size:16})})}),e.jsxs(Ie,{align:"end",children:[e.jsxs(y,{className:"cursor-pointer",onClick:()=>xe(a.id),children:[e.jsx(Je,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Visualizar"})]}),a.status!=="paid"&&e.jsxs(e.Fragment,{children:[e.jsxs(y,{className:"cursor-pointer",onClick:()=>K(a.id),children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Registrar Pagamento"})]}),q&&e.jsxs(y,{className:"cursor-pointer",onClick:()=>ye(a.id),children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Gerar PIX"})]})]}),e.jsxs(y,{className:"cursor-pointer",onClick:()=>fe(a),children:[e.jsx(Me,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Reimprimir"})]}),e.jsxs(y,{className:"cursor-pointer",onClick:()=>je(a.id),children:[e.jsx(Te,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Editar"})]})]})]})})]},a.id))})]})})})]}),e.jsx(F,{open:ie,onOpenChange:D,children:e.jsxs(A,{className:"max-w-3xl",children:[e.jsxs(T,{children:[e.jsx(R,{children:"Detalhes da Fatura"}),e.jsx(O,{children:"Visualize os detalhes completos da fatura."})]}),r&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold",children:r.invoiceNumber}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Referência: ",Z(r.referenceMonth),"/",r.referenceYear]})]}),e.jsx(te,{status:r.status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Unidade"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(Se,{className:"h-4 w-4 mr-1 text-muted-foreground"}),r.unit]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Morador"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(Ee,{className:"h-4 w-4 mr-1 text-muted-foreground"}),r.resident]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Vencimento"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(Fe,{className:"h-4 w-4 mr-1 text-muted-foreground"}),X(r.dueDate)]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Valor Total"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(Ae,{className:"h-4 w-4 mr-1 text-muted-foreground"}),L(r.totalAmount)]})]}),r.status==="paid"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Data de Pagamento"}),e.jsx("p",{className:"font-medium",children:r.paymentDate?X(r.paymentDate):"N/A"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Método de Pagamento"}),e.jsx("p",{className:"font-medium capitalize",children:r.paymentMethod?r.paymentMethod.replace("_"," "):"N/A"})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Itens da Fatura"}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(ae,{children:[e.jsx(se,{children:e.jsxs(x,{children:[e.jsx(l,{children:"Descrição"}),e.jsx(l,{className:"text-right",children:"Valor"})]})}),e.jsx(re,{children:r.items.length===0?e.jsx(x,{children:e.jsx(i,{colSpan:2,className:"text-center py-4 text-muted-foreground",children:"Nenhum item encontrado."})}):r.items.map(a=>e.jsxs(x,{children:[e.jsx(i,{children:a.description}),e.jsx(i,{className:"text-right font-medium",children:L(a.amount)})]},a.id||a.billingId))})]})})]}),r.notes&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Observações"}),e.jsx("p",{className:"text-sm p-3 bg-muted rounded-md",children:r.notes})]})]}),e.jsxs(V,{children:[e.jsx(c,{variant:"outline",onClick:()=>D(!1),children:"Fechar"}),r&&r.status!=="paid"&&e.jsx(c,{onClick:()=>{D(!1),K(r.id)},children:"Registrar Pagamento"})]})]})}),e.jsx(F,{open:ce,onOpenChange:P,children:e.jsxs(A,{className:"max-w-md",children:[e.jsxs(T,{children:[e.jsx(R,{children:"Registrar Pagamento"}),e.jsxs(O,{children:["Registre o pagamento da fatura ",r==null?void 0:r.invoiceNumber,"."]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"payment-method",children:"Método de Pagamento"}),e.jsxs(Q,{value:o.method,onValueChange:a=>S({...o,method:a}),children:[e.jsx(_,{id:"payment-method",children:e.jsx(J,{placeholder:"Selecione o método de pagamento"})}),e.jsxs(U,{children:[e.jsx(u,{value:"pix",children:"PIX"}),e.jsx(u,{value:"bank_transfer",children:"Transferência Bancária"}),e.jsx(u,{value:"cash",children:"Dinheiro"}),e.jsx(u,{value:"check",children:"Cheque"}),e.jsx(u,{value:"other",children:"Outro"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"payment-account",children:"Conta de Recebimento"}),e.jsxs(Q,{value:o.accountId,onValueChange:a=>S({...o,accountId:a}),children:[e.jsx(_,{id:"payment-account",children:e.jsx(J,{placeholder:"Selecione a conta bancária"})}),e.jsx(U,{children:G.map(a=>e.jsxs(u,{value:a.id.toString(),children:[a.name," - ",a.bank]},a.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"payment-date",children:"Data do Pagamento"}),e.jsx(H,{id:"payment-date",type:"date",value:o.date,onChange:a=>S({...o,date:a.target.value})})]})]}),e.jsxs(V,{children:[e.jsx(c,{variant:"outline",onClick:()=>P(!1),children:"Cancelar"}),e.jsx(c,{onClick:pe,children:"Confirmar Pagamento"})]})]})}),e.jsx(F,{open:de,onOpenChange:I,children:e.jsxs(A,{className:"max-w-md",children:[e.jsxs(T,{children:[e.jsx(R,{children:"Editar Fatura"}),e.jsxs(O,{children:["Edite os detalhes da fatura ",r==null?void 0:r.invoiceNumber,"."]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"edit-due-date",children:"Data de Vencimento"}),e.jsx(H,{id:"edit-due-date",type:"date",value:m.dueDate,onChange:a=>E({...m,dueDate:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"edit-status",children:"Status"}),e.jsxs(Q,{value:m.status,onValueChange:a=>E({...m,status:a}),children:[e.jsx(_,{id:"edit-status",children:e.jsx(J,{placeholder:"Selecione o status"})}),e.jsxs(U,{children:[e.jsx(u,{value:"pending",children:"Pendente"}),e.jsx(u,{value:"paid",children:"Pago"}),e.jsx(u,{value:"overdue",children:"Atrasado"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"edit-notes",children:"Observações"}),e.jsx(H,{id:"edit-notes",value:m.notes,onChange:a=>E({...m,notes:a.target.value})})]})]}),e.jsxs(V,{children:[e.jsx(c,{variant:"outline",onClick:()=>I(!1),children:"Cancelar"}),e.jsx(c,{onClick:ge,children:"Salvar Alterações"})]})]})}),e.jsx(F,{open:le,onOpenChange:z,children:e.jsxs(A,{className:"max-w-md",children:[e.jsxs(T,{children:[e.jsx(R,{children:"Pagamento via PIX"}),e.jsxs(O,{children:["Escaneie o QR Code abaixo para pagar a fatura ",r==null?void 0:r.invoiceNumber,"."]})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-4",children:[k&&e.jsx("div",{className:"border rounded-md p-4 bg-white",children:e.jsx("img",{src:k,alt:"QR Code PIX",className:"w-64 h-64"})}),e.jsx("p",{className:"text-sm text-muted-foreground mt-4 text-center",children:"Após o pagamento, o administrador precisará confirmar o recebimento."})]}),e.jsxs(V,{children:[e.jsx(c,{variant:"outline",onClick:()=>z(!1),children:"Fechar"}),k&&e.jsx(c,{onClick:()=>window.open(k,"_blank"),children:"Abrir QR Code"})]})]})})]})};export{ta as default};
